document.addEventListener("DOMContentLoaded",()=>{class a{constructor({edit_user_settings_el:a,edit_user_settings_error_text:b,edit_user_settings_fetch_url:c,tree_container_ref_id:d,tree_el:e,tree_empty_text:f,tree_error_text:g,tree_fetch_url:h,tree_link_objects:i}){this.edit_user_settings_el=a,this.edit_user_settings_error_text=b,this.edit_user_settings_fetch_url=c,this.tree_container_ref_id=d,this.tree_el=e,this.tree_empty_text=f,this.tree_error_text=g,this.tree_fetch_url=h,this.tree_link_objects=i}clearElement({el:a}){a.innerHTML=""}async clickNode({arrow_el:a,children_el:b,current_deep:c,ref_id:d}){a.classList.toggle("SrContainerObjectTreeArrowOpen"),0===b.children.length&&(await this.fetchTree({parent_deep:c,parent_el:b,parent_ref_id:d}))}async fetchEditUserSettings({parent_el:a}){const b=this.insertLoading({parent_el:a});let c;try{c=await(await fetch(this.edit_user_settings_fetch_url,{headers:{accept:"text/html"}})).text()}catch(b){return void this.insertError({err:b,error_text:this.edit_user_settings_error_text,parent_el:a})}finally{this.removeLoading({loading_el:b,parent_el:a})}this.initEditUserSettingsForm({html:c,parent_el:a})}async fetchTree({parent_deep:a,parent_el:b,parent_ref_id:c}){const d=this.insertLoading({parent_el:b});let e;try{e=await(await fetch(this.tree_fetch_url.replace(":parent_ref_id",c).replace(":parent_deep",a),{headers:{accept:"application/json"}})).json()}catch(a){return void this.insertError({err:a,error_text:this.tree_error_text,parent_el:b})}finally{this.removeLoading({loading_el:d,parent_el:b})}const{current_deep:f,children:g}=e;if(0<g.length)for(const{count_sub_children_types:a,description:c,icon:d,is_container:e,link:h,ref_id:i,start_deep:j,title:k}of g){const g=document.createElement("div");g.classList.add("SrContainerObjectTreeNode");const l=document.createElement("div");l.classList.add("SrContainerObjectTreeChildren");const m=document.createElement(this.tree_link_objects?"a":"div");m.classList.add("SrContainerObjectTreeLink"),this.tree_link_objects&&(m.href=h,m.target="_blank");const n=document.createElement("img");n.classList.add("SrContainerObjectTreeIcon"),n.src=d,m.appendChild(n);const o=document.createElement("div");if(o.classList.add("SrContainerObjectTreeTitle"),o.innerText=k,m.appendChild(o),e){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeArrow");const b=this.clickNode.bind(this,{arrow_el:a,children_el:l,current_deep:f,ref_id:i});j?b():(a.addEventListener("click",b),!this.tree_link_objects&&m.addEventListener("click",b),g.appendChild(a))}if(g.appendChild(m),c){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeDescription"),a.innerText=c,g.appendChild(a)}if(e&&0<a.length){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeCountSubChildrenTypes"),b.innerText=a.map(({count:a,type_title:b})=>`${a} ${b}`).join(", "),g.appendChild(b)}e&&g.appendChild(l),b.appendChild(g)}else{const a=document.createElement("div");a.classList.add("SrContainerObjectTreeEmpty"),a.innerText=this.tree_empty_text,b.appendChild(a)}}init(){this.initTree(),this.initEditUserSettings()}async initTree(){this.clearElement({el:this.tree_el}),await this.fetchTree({parent_deep:0,parent_el:this.tree_el,parent_ref_id:this.tree_container_ref_id})}async initEditUserSettings(){await this.fetchEditUserSettings({parent_el:this.edit_user_settings_el})}initEditUserSettingsForm({html:a,parent_el:b}){b.insertAdjacentHTML("beforeend",a);const c=b.querySelector("form");c.addEventListener("change",this.updateEditUserSettings.bind(this,{form:c,parent_el:b}))}insertError({err:a,error_text:b,parent_el:c}){console.error(a);const d=document.createElement("div");return d.classList.add("SrContainerObjectTreeError"),d.innerText=b,c.appendChild(d),d}insertLoading({parent_el:a}){const b=document.createElement("div");return b.classList.add("SrContainerObjectTreeLoading"),a.appendChild(b),b}removeLoading({loading_el:a,parent_el:b}){b.removeChild(a)}async updateEditUserSettings({form:a,parent_el:b}){const c=new FormData(a);for(const c of a.querySelectorAll("button,input,select,textarea"))c.disabled=!0;const d=this.insertLoading({parent_el:b});let e;try{e=await(await fetch(a.action,{body:c,headers:{accept:"application/json"},method:a.method})).json()}catch(a){return void this.insertError({err:a,error_text:this.edit_user_settings_error_text,parent_el:b})}finally{this.removeLoading({loading_el:d,parent_el:b})}this.clearElement({el:b});const{html:f,ok:g}=e;this.initEditUserSettingsForm({html:f,parent_el:b}),g&&(await this.initTree())}}for(const b of document.querySelectorAll(".SrContainerObjectTree")){const c=JSON.parse(atob(b.dataset.config));c.edit_user_settings_el=b.querySelector(".SrContainerObjectTreeEditUserSettings"),c.tree_el=b.querySelector(".SrContainerObjectTreeTree");const d=new a(c);d.init()}});
