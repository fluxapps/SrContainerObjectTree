document.addEventListener("DOMContentLoaded",()=>{class a{constructor({edit_user_settings_error_text:a,edit_user_settings_form_el:b,edit_user_settings_icon_el:c,tree_children:d,tree_el:e,tree_empty_text:f,tree_fetch_url:g,tree_link_container_objects:h,tree_link_new_tab:i,tree_show_metadata:j,tree_start_deep:k}){this.edit_user_settings_error_text=a,this.edit_user_settings_form_el=b,this.edit_user_settings_icon_el=c,this.tree_children=d,this.tree_el=e,this.tree_empty_text=f,this.tree_fetch_url=g,this.tree_link_container_objects=h,this.tree_link_new_tab=i,this.tree_show_metadata=j,this.tree_start_deep=k,this._handleCloseUserSettingsIconClose=null,this._handleEscCloseUserSettingsIcon=null}clearElement({el:a}){a.innerHTML=""}async clickNode({arrow_el:a,children:b,children_el:c,parent_deep:d}){a.classList.toggle("SrContainerObjectTreeArrowOpen"),0===c.children.length&&(await this.initNode({children:b,parent_deep:d,parent_el:c}))}async handleOpenCloseUserSettingsIcon({forceOpenStatus:a}){this.edit_user_settings_icon_el.classList.toggle("SrContainerObjectTreeEditUserSettingsIconOpen",a),this.edit_user_settings_icon_el.classList.contains("SrContainerObjectTreeEditUserSettingsIconOpen")?(document.addEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.addEventListener("click",this.handleCloseUserSettingsIconClose)):(document.removeEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.removeEventListener("click",this.handleCloseUserSettingsIconClose))}get handleCloseUserSettingsIconClose(){return this._handleCloseUserSettingsIconClose||(this._handleCloseUserSettingsIconClose=this.handleOpenCloseUserSettingsIcon.bind(this,{forceOpenStatus:!1})),this._handleCloseUserSettingsIconClose}get handleEscCloseUserSettingsIcon(){return this._handleEscCloseUserSettingsIcon||(this._handleEscCloseUserSettingsIcon=a=>{"Escape"===a.key&&this.handleCloseUserSettingsIconClose()}),this._handleEscCloseUserSettingsIcon}init(){this.initTree(),this.initEditUserSettings()}async initNode({children:a,parent_deep:b,parent_el:c}){for(const{count_sub_children_types:d,description:e,icon:f,is_container:g,link:h,preloaded_children:i,title:j}of a){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeNode");const k=document.createElement("div");k.classList.add("SrContainerObjectTreeChildren");const l=document.createElement(h?"a":"div");l.classList.add("SrContainerObjectTreeLink"),(!g||this.tree_link_container_objects)&&(l.href=h,this.tree_link_new_tab&&(l.target="_blank"));const m=document.createElement("img");m.classList.add("SrContainerObjectTreeIcon"),m.src=f,l.appendChild(m);const n=document.createElement("div");if(n.classList.add("SrContainerObjectTreeTitle"),n.innerText=j,l.appendChild(n),g){const c=document.createElement("div");c.classList.add("SrContainerObjectTreeArrow");const d=this.clickNode.bind(this,{arrow_el:c,children:i,children_el:k,parent_deep:b+1});c.addEventListener("click",d),this.tree_link_container_objects||l.addEventListener("click",d),a.appendChild(c),b<this.tree_start_deep&&d()}if(a.appendChild(l),this.tree_show_metadata){if(e){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeDescription"),b.innerText=e,a.appendChild(b)}if(g&&0<d.length){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeCountSubChildrenTypes"),b.innerText=d.map(({count:a,type_title:b})=>`${a} ${b}`).join(", "),a.appendChild(b)}}g&&a.appendChild(k),c.appendChild(a)}}async initTree(){if(this.clearElement({el:this.tree_el}),0<this.tree_children.length)await this.initNode({children:this.tree_children,parent_deep:1,parent_el:this.tree_el});else{const a=document.createElement("div");a.classList.add("SrContainerObjectTreeEmpty"),a.innerText=this.tree_empty_text,this.tree_el.appendChild(a)}}async initEditUserSettings(){this.edit_user_settings_icon_el.addEventListener("click",this.handleOpenCloseUserSettingsIcon.bind(this,{}));for(const a of[this.edit_user_settings_form_el,this.edit_user_settings_icon_el])a.addEventListener("click",a=>{a.stopPropagation()});const a=this.edit_user_settings_form_el.querySelector("form");a.addEventListener("change",this.updateEditUserSettings.bind(this,{form:a}))}insertError({err:a,error_text:b,parent_el:c}){console.error(a);const d=document.createElement("div");return d.classList.add("SrContainerObjectTreeError"),d.innerText=b,c.appendChild(d),d}insertLoading({parent_el:a}){const b=document.createElement("div");return b.classList.add("SrContainerObjectTreeLoading"),a.appendChild(b),b}removeLoading({loading_el:a,parent_el:b}){b.removeChild(a)}async updateEditUserSettings({form:a}){const b=new FormData(a);for(const b of a.elements)b.disabled=!0;let c;const d=this.insertLoading({parent_el:this.edit_user_settings_form_el});try{c=await(await fetch(a.action,{body:b,headers:{accept:"application/json"},method:a.method})).json()}catch(a){return void this.insertError({err:a,error_text:this.edit_user_settings_error_text,parent_el:this.edit_user_settings_form_el})}finally{this.removeLoading({loading_el:d,parent_el:this.edit_user_settings_form_el})}for(const b of a.elements)b.disabled=!1;const{show_metadata:e,start_deep:f}=c;this.tree_show_metadata=e,this.tree_start_deep=f,await this.initTree()}}for(const b of document.querySelectorAll(".SrContainerObjectTree")){const c=JSON.parse(atob(b.dataset.config)),d=b.querySelector(".SrContainerObjectTreeEditUserSettings");c.edit_user_settings_form_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsForm"),c.edit_user_settings_icon_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsIcon"),c.tree_el=b.querySelector(".SrContainerObjectTreeTree");const e=new a(c);e.init()}});
