document.addEventListener("DOMContentLoaded",()=>{class a{static get STORAGE(){return sessionStorage}static get STORAGE_CACHE_KEY(){return"SrContainerObjectTreeCache"}constructor({edit_user_settings_el:a,edit_user_settings_form_container_el:b,edit_user_settings_icon_el:c,edit_user_settings_update_url:d,plugin_version:e,texts:{edit_user_settings_deep_x:k,edit_user_settings_hide_metadata:l,edit_user_settings_save_error:m,edit_user_settings_show_metadata:n,tree_apply:o,tree_empty:p,tree_fetch_error:q,tree_loaded_from_cache:r,tree_has_changed_meanwhile:s},tree_el:f,tree_fetch_url:g,tree_link_container_objects:h,tree_link_new_tab:i,tree_show_metadata:j}){this.edit_user_settings_el=a,this.edit_user_settings_form_container_el=b,this.edit_user_settings_icon_el=c,this.edit_user_settings_update_url=d,this.plugin_version=e,this.texts={edit_user_settings_deep_x:k,edit_user_settings_hide_metadata:l,edit_user_settings_save_error:m,edit_user_settings_show_metadata:n,tree_apply:o,tree_empty:p,tree_fetch_error:q,tree_loaded_from_cache:r,tree_has_changed_meanwhile:s},this.tree_el=f,this.tree_fetch_url=g,this.tree_link_container_objects=h,this.tree_link_new_tab=i,this.tree_show_metadata=j,this._cache_el=null,this._edit_user_settings_form_el=null,this._edit_user_settings_show_metadata_el=null,this._edit_user_settings_start_deep_el=null,this._handleCloseUserSettingsIconClose=null,this._handleEscCloseUserSettingsIcon=null,this._is_load_from_cache=!1,this._tree_data={fetched_data:{tree_children:null,tree_min_deep:null,tree_max_deep:null,tree_start_deep:null},fetched_time:null,fetched_with_plugin_version:null}}applyTreeData({tree_data:a}){this._tree_data=a,this._edit_user_settings_start_deep_el.innerHTML="";for(let b=this._tree_data.fetched_data.tree_min_deep;b<=this._tree_data.fetched_data.tree_max_deep;b++){const a=document.createElement("option");a.value=b,a.text=this.texts.edit_user_settings_deep_x.replace("_deep_",b),this._edit_user_settings_start_deep_el.appendChild(a)}this._edit_user_settings_start_deep_el.size=this._edit_user_settings_start_deep_el.options.length,this._edit_user_settings_start_deep_el.value=this._tree_data.fetched_data.tree_start_deep}async backgroundFetchTree(){const a=await this.fetchTree({parent_el:null});if(a&&JSON.stringify(a.fetched_data)!==JSON.stringify(this._tree_data.fetched_data)){this._cache_el.innerText+=`\n\n${this.texts.tree_has_changed_meanwhile}\n`;const b=document.createElement("button");b.type="button",b.classList.add("btn","btn-default"),b.innerText=this.texts.tree_apply,b.addEventListener("click",this.clickBackgroundFetchTreeApply.bind(this,{tree_data:a})),this._cache_el.appendChild(b)}}async clickBackgroundFetchTreeApply({tree_data:a}){this.applyTreeData({tree_data:a}),await this.initTree()}async clickNode({arrow_el:a,children:b,children_el:c,parent_deep:d}){a.classList.toggle("SrContainerObjectTreeArrowOpen"),0===c.children.length&&(await this.initNode({children:b,parent_deep:d,parent_el:c}))}async fetchTree({parent_el:a}){let b;const c=this.insertLoading({parent_el:a});try{b=await(await fetch(this.tree_fetch_url,{headers:{accept:"application/json"}})).json()}catch(b){return void this.insertError({err:b,error_text:this.texts.tree_fetch_error,parent_el:a})}finally{a&&a.removeChild(c)}const d={fetched_data:b,fetched_time:Date.now(),fetched_with_plugin_version:this.plugin_version};return this.constructor.STORAGE[this.constructor.STORAGE_CACHE_KEY]=JSON.stringify(d),d}async handleOpenCloseUserSettingsIcon({forceOpenStatus:a}){this.edit_user_settings_icon_el.classList.toggle("SrContainerObjectTreeEditUserSettingsIconOpen",a),this.edit_user_settings_icon_el.classList.contains("SrContainerObjectTreeEditUserSettingsIconOpen")?(document.addEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.addEventListener("click",this.handleCloseUserSettingsIconClose)):(document.removeEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.removeEventListener("click",this.handleCloseUserSettingsIconClose))}get handleCloseUserSettingsIconClose(){return this._handleCloseUserSettingsIconClose||(this._handleCloseUserSettingsIconClose=this.handleOpenCloseUserSettingsIcon.bind(this,{forceOpenStatus:!1})),this._handleCloseUserSettingsIconClose}get handleEscCloseUserSettingsIcon(){return this._handleEscCloseUserSettingsIcon||(this._handleEscCloseUserSettingsIcon=a=>{"Escape"===a.key&&this.handleCloseUserSettingsIconClose()}),this._handleEscCloseUserSettingsIcon}async init(){await this.initEditUserSettings(),await this.initTree()}async initNode({children:a,parent_deep:b,parent_el:c}){for(const{children:d,count_sub_children_types:e,description:f,icon:g,is_container:h,link:i,title:j}of a){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeNode");const k=document.createElement("div");k.classList.add("SrContainerObjectTreeChildren");const l=document.createElement(i?"a":"div");l.classList.add("SrContainerObjectTreeLink"),(!h||this.tree_link_container_objects)&&(l.href=i,this.tree_link_new_tab&&(l.target="_blank"));const m=document.createElement("img");m.classList.add("SrContainerObjectTreeIcon"),m.src=g,l.appendChild(m);const n=document.createElement("div");if(n.classList.add("SrContainerObjectTreeTitle"),n.innerText=j,l.appendChild(n),h){const c=document.createElement("div");c.classList.add("SrContainerObjectTreeArrow");const e=this.clickNode.bind(this,{arrow_el:c,children:d,children_el:k,parent_deep:b+1});c.addEventListener("click",e),this.tree_link_container_objects||l.addEventListener("click",e),a.appendChild(c),b<this._tree_data.fetched_data.tree_start_deep&&e()}if(a.appendChild(l),this.tree_show_metadata){if(f){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeDescription"),b.innerText=f,a.appendChild(b)}if(h&&0<e.length){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeCountSubChildrenTypes"),b.innerText=e.map(({count:a,type_title:b})=>`${a} ${b}`).join(", "),a.appendChild(b)}}h&&a.appendChild(k),c.appendChild(a)}}async initTree(){this.edit_user_settings_el.classList.remove("SrContainerObjectTreeEditUserSettingsShow"),this.tree_el.innerHTML="";let a=!1;if(!this._tree_data.fetched_data.tree_children){let b=this.constructor.STORAGE[this.constructor.STORAGE_CACHE_KEY];if(b)try{b=JSON.parse(b)}catch(a){this.insertError({err:a}),b=null}b&&b.fetched_with_plugin_version!==this.plugin_version&&(b=null);let c;if(b)c=b,this._is_load_from_cache=!0,a=!0;else{if(c=await this.fetchTree({parent_el:this.tree_el}),!c)return;this._is_load_from_cache=!1}this.applyTreeData({tree_data:c})}if(0<this._tree_data.fetched_data.tree_children.length)await this.initNode({children:this._tree_data.fetched_data.tree_children,parent_deep:1,parent_el:this.tree_el});else{const a=document.createElement("div");a.classList.add("SrContainerObjectTreeEmpty"),a.innerText=this.texts.tree_empty,this.tree_el.appendChild(a)}this._is_load_from_cache&&(!this._cache_el&&(this._cache_el=document.createElement("div"),this._cache_el.classList.add("SrContainerObjectTreeCache"),this.edit_user_settings_el.appendChild(this._cache_el)),this._cache_el.innerText=this.texts.tree_loaded_from_cache.replace("_date_",new Date(this._tree_data.fetched_time).toLocaleString()),a&&this.backgroundFetchTree()),this.edit_user_settings_el.classList.add("SrContainerObjectTreeEditUserSettingsShow")}async initEditUserSettings(){this._edit_user_settings_form_el=document.createElement("form");const a=document.createElement("option");a.value="show",a.text=this.texts.edit_user_settings_show_metadata;const b=document.createElement("option");b.value="hide",b.text=this.texts.edit_user_settings_hide_metadata,this._edit_user_settings_show_metadata_el=document.createElement("select"),this._edit_user_settings_show_metadata_el.appendChild(a),this._edit_user_settings_show_metadata_el.appendChild(b),this._edit_user_settings_show_metadata_el.size=this._edit_user_settings_show_metadata_el.options.length,this._edit_user_settings_show_metadata_el.value=this.tree_show_metadata?"show":"hide",this._edit_user_settings_form_el.appendChild(this._edit_user_settings_show_metadata_el),this._edit_user_settings_start_deep_el=document.createElement("select"),this._edit_user_settings_form_el.appendChild(this._edit_user_settings_start_deep_el),this.edit_user_settings_form_container_el.appendChild(this._edit_user_settings_form_el),this.edit_user_settings_icon_el.addEventListener("click",this.handleOpenCloseUserSettingsIcon.bind(this,{}));for(const a of[this.edit_user_settings_form_container_el,this.edit_user_settings_icon_el])a.addEventListener("click",a=>{a.stopPropagation()});this._edit_user_settings_form_el.addEventListener("change",this.updateEditUserSettings.bind(this))}insertError({err:a,error_text:b,parent_el:c}){if(console.error(a),c){const a=document.createElement("div");return a.classList.add("SrContainerObjectTreeError"),a.innerText=b,c.appendChild(a),a}}insertLoading({parent_el:a}){if(a){const b=document.createElement("div");return b.classList.add("SrContainerObjectTreeLoading"),a.appendChild(b),b}}async updateEditUserSettings(){for(const a of this._edit_user_settings_form_el.elements)a.disabled=!0;let a;const b=this.insertLoading({parent_el:this.edit_user_settings_form_container_el});try{a=await(await fetch(this.edit_user_settings_update_url,{body:JSON.stringify({show_metadata:"show"===this._edit_user_settings_show_metadata_el.value,start_deep:this._edit_user_settings_start_deep_el.value}),headers:{accept:"application/json","content-type":"application/json"},method:"post"})).json()}catch(a){return void this.insertError({err:a,error_text:this.texts.edit_user_settings_save_error,parent_el:this.edit_user_settings_form_container_el})}finally{this.edit_user_settings_form_container_el.removeChild(b)}for(const a of this._edit_user_settings_form_el.elements)a.disabled=!1;const{show_metadata:c,start_deep:d}=a;this.tree_show_metadata=c,this._edit_user_settings_show_metadata_el.value=this.tree_show_metadata?"show":"hide",this._tree_data.fetched_data.tree_start_deep=this._edit_user_settings_start_deep_el.value=d,await this.initTree()}}for(const b of document.querySelectorAll(".SrContainerObjectTree")){const c=JSON.parse(atob(b.dataset.config));c.edit_user_settings_el=b.querySelector(".SrContainerObjectTreeEditUserSettings"),c.edit_user_settings_form_container_el=c.edit_user_settings_el.querySelector(".SrContainerObjectTreeEditUserSettingsFormContainer"),c.edit_user_settings_icon_el=c.edit_user_settings_el.querySelector(".SrContainerObjectTreeEditUserSettingsIcon"),c.tree_el=b.querySelector(".SrContainerObjectTreeTree");const d=new a(c);d.init()}});
