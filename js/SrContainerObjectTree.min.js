document.addEventListener("DOMContentLoaded",()=>{class a{constructor({edit_user_settings_error_text:a,edit_user_settings_fetch_url:b,edit_user_settings_form_el:c,edit_user_settings_icon_el:d,tree_container_ref_id:e,tree_el:f,tree_empty_text:g,tree_error_text:h,tree_fetch_url:i}){this.edit_user_settings_error_text=a,this.edit_user_settings_fetch_url=b,this.edit_user_settings_form_el=c,this.edit_user_settings_icon_el=d,this.tree_container_ref_id=e,this.tree_el=f,this.tree_empty_text=g,this.tree_error_text=h,this.tree_fetch_url=i,this._handleCloseUserSettingsIconClose=null,this._handleEscCloseUserSettingsIcon=null}clearElement({el:a}){a.innerHTML=""}async clickNode({arrow_el:a,children_el:b,ref_id:c,start_deep_children:d}){a.classList.toggle("SrContainerObjectTreeArrowOpen"),0===b.children.length&&(await this.fetchTree({parent_el:b,parent_ref_id:c,start_deep_children:d}))}async handleOpenCloseUserSettingsIcon({forceOpenStatus:a}){this.edit_user_settings_icon_el.classList.toggle("SrContainerObjectTreeEditUserSettingsIconOpen",a),this.edit_user_settings_icon_el.classList.contains("SrContainerObjectTreeEditUserSettingsIconOpen")?(document.addEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.addEventListener("click",this.handleCloseUserSettingsIconClose)):(document.removeEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.removeEventListener("click",this.handleCloseUserSettingsIconClose))}get handleCloseUserSettingsIconClose(){return this._handleCloseUserSettingsIconClose||(this._handleCloseUserSettingsIconClose=this.handleOpenCloseUserSettingsIcon.bind(this,{forceOpenStatus:!1})),this._handleCloseUserSettingsIconClose}get handleEscCloseUserSettingsIcon(){return this._handleEscCloseUserSettingsIcon||(this._handleEscCloseUserSettingsIcon=a=>{"Escape"===a.key&&this.handleCloseUserSettingsIconClose()}),this._handleEscCloseUserSettingsIcon}async fetchEditUserSettings({parent_el:a}){const b=this.insertLoading({parent_el:a});let c;try{c=await(await fetch(this.edit_user_settings_fetch_url,{headers:{accept:"application/json"}})).json()}catch(b){return void this.insertError({err:b,error_text:this.edit_user_settings_error_text,parent_el:a})}finally{this.removeLoading({loading_el:b,parent_el:a})}const{html:d}=c;this.initEditUserSettingsForm({html:d,parent_el:a})}async fetchTree({parent_el:a,parent_ref_id:b,start_deep_children:c}){let d;if(c)d=c;else{const c=this.insertLoading({parent_el:a});try{d=await(await fetch(this.tree_fetch_url.replace(":parent_ref_id",b),{headers:{accept:"application/json"}})).json()}catch(b){return void this.insertError({err:b,error_text:this.tree_error_text,parent_el:a})}finally{this.removeLoading({loading_el:c,parent_el:a})}}const{children:e}=d;if(0<e.length)for(const{count_sub_children_types:b,description:c,icon:d,is_container:f,link:g,link_new_tab:h,ref_id:i,start_deep_children:j,title:k}of e){const e=document.createElement("div");e.classList.add("SrContainerObjectTreeNode");const l=document.createElement("div");l.classList.add("SrContainerObjectTreeChildren");const m=document.createElement(g?"a":"div");m.classList.add("SrContainerObjectTreeLink"),g&&(m.href=g,h&&(m.target="_blank"));const n=document.createElement("img");n.classList.add("SrContainerObjectTreeIcon"),n.src=d,m.appendChild(n);const o=document.createElement("div");if(o.classList.add("SrContainerObjectTreeTitle"),o.innerText=k,m.appendChild(o),f){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeArrow");const b=this.clickNode.bind(this,{arrow_el:a,children_el:l,ref_id:i,start_deep_children:j});a.addEventListener("click",b),g||m.addEventListener("click",b),e.appendChild(a),j&&b()}if(e.appendChild(m),c){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeDescription"),a.innerText=c,e.appendChild(a)}if(f&&0<b.length){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeCountSubChildrenTypes"),a.innerText=b.map(({count:a,type_title:b})=>`${a} ${b}`).join(", "),e.appendChild(a)}f&&e.appendChild(l),a.appendChild(e)}else{const b=document.createElement("div");b.classList.add("SrContainerObjectTreeEmpty"),b.innerText=this.tree_empty_text,a.appendChild(b)}}init(){this.initTree(),this.initEditUserSettings()}async initTree(){this.clearElement({el:this.tree_el}),await this.fetchTree({parent_el:this.tree_el,parent_ref_id:this.tree_container_ref_id})}async initEditUserSettings(){this.edit_user_settings_icon_el.addEventListener("click",this.handleOpenCloseUserSettingsIcon.bind(this,{}));for(const a of[this.edit_user_settings_form_el,this.edit_user_settings_icon_el])a.addEventListener("click",a=>{a.stopPropagation()});await this.fetchEditUserSettings({parent_el:this.edit_user_settings_form_el})}initEditUserSettingsForm({html:a,parent_el:b}){b.insertAdjacentHTML("beforeend",a);const c=b.querySelector("form");c.addEventListener("change",this.updateEditUserSettings.bind(this,{form:c,parent_el:b}))}insertError({err:a,error_text:b,parent_el:c}){console.error(a);const d=document.createElement("div");return d.classList.add("SrContainerObjectTreeError"),d.innerText=b,c.appendChild(d),d}insertLoading({parent_el:a}){const b=document.createElement("div");return b.classList.add("SrContainerObjectTreeLoading"),a.appendChild(b),b}removeLoading({loading_el:a,parent_el:b}){b.removeChild(a)}async updateEditUserSettings({form:a,parent_el:b}){const c=new FormData(a);for(const c of a.querySelectorAll("button,input,select,textarea"))c.disabled=!0;const d=this.insertLoading({parent_el:b});let e;try{e=await(await fetch(a.action,{body:c,headers:{accept:"application/json"},method:a.method})).json()}catch(a){return void this.insertError({err:a,error_text:this.edit_user_settings_error_text,parent_el:b})}finally{this.removeLoading({loading_el:d,parent_el:b})}this.clearElement({el:b});const{html:f,ok:g}=e;this.initEditUserSettingsForm({html:f,parent_el:b}),g&&(await this.initTree())}}for(const b of document.querySelectorAll(".SrContainerObjectTree")){const c=JSON.parse(atob(b.dataset.config)),d=b.querySelector(".SrContainerObjectTreeEditUserSettings");c.edit_user_settings_form_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsForm"),c.edit_user_settings_icon_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsIcon"),c.tree_el=b.querySelector(".SrContainerObjectTreeTree");const e=new a(c);e.init()}});
