document.addEventListener("DOMContentLoaded",()=>{class a{constructor({edit_user_settings_error_text:a,edit_user_settings_fetch_url:b,edit_user_settings_form_el:c,edit_user_settings_icon_el:d,tree_container_ref_id:e,tree_el:f,tree_empty_text:g,tree_error_text:h,tree_fetch_url:i}){this.edit_user_settings_error_text=a,this.edit_user_settings_fetch_url=b,this.edit_user_settings_form_el=c,this.edit_user_settings_icon_el=d,this.tree_container_ref_id=e,this.tree_el=f,this.tree_empty_text=g,this.tree_error_text=h,this.tree_fetch_url=i,this._handleCloseUserSettingsIconClose=null,this._handleEscCloseUserSettingsIcon=null}clearElement({el:a}){a.innerHTML=""}async clickNode({arrow_el:a,children_el:b,current_deep:c,ref_id:d}){a.classList.toggle("SrContainerObjectTreeArrowOpen"),0===b.children.length&&(await this.fetchTree({parent_deep:c,parent_el:b,parent_ref_id:d}))}async handleOpenCloseUserSettingsIcon({forceOpenStatus:a}){this.edit_user_settings_icon_el.classList.toggle("SrContainerObjectTreeEditUserSettingsIconOpen",a),this.edit_user_settings_icon_el.classList.contains("SrContainerObjectTreeEditUserSettingsIconOpen")?(document.addEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.addEventListener("click",this.handleCloseUserSettingsIconClose)):(document.removeEventListener("keydown",this.handleEscCloseUserSettingsIcon),document.body.removeEventListener("click",this.handleCloseUserSettingsIconClose))}get handleCloseUserSettingsIconClose(){return this._handleCloseUserSettingsIconClose||(this._handleCloseUserSettingsIconClose=this.handleOpenCloseUserSettingsIcon.bind(this,{forceOpenStatus:!1})),this._handleCloseUserSettingsIconClose}get handleEscCloseUserSettingsIcon(){return this._handleEscCloseUserSettingsIcon||(this._handleEscCloseUserSettingsIcon=a=>{"Escape"===a.key&&this.handleCloseUserSettingsIconClose()}),this._handleEscCloseUserSettingsIcon}async fetchEditUserSettings({parent_el:a}){const b=this.insertLoading({parent_el:a});let c;try{c=await(await fetch(this.edit_user_settings_fetch_url,{headers:{accept:"application/json"}})).json()}catch(b){return void this.insertError({err:b,error_text:this.edit_user_settings_error_text,parent_el:a})}finally{this.removeLoading({loading_el:b,parent_el:a})}const{html:d}=c;this.initEditUserSettingsForm({html:d,parent_el:a})}async fetchTree({parent_deep:a,parent_el:b,parent_ref_id:c}){const d=this.insertLoading({parent_el:b});let e;try{e=await(await fetch(this.tree_fetch_url.replace(":parent_ref_id",c).replace(":parent_deep",a),{headers:{accept:"application/json"}})).json()}catch(a){return void this.insertError({err:a,error_text:this.tree_error_text,parent_el:b})}finally{this.removeLoading({loading_el:d,parent_el:b})}const{current_deep:f,children:g}=e;if(0<g.length)for(const{count_sub_children_types:a,description:c,icon:d,is_container:e,link:h,link_new_tab:i,ref_id:j,show_arrow:k,start_deep:l,title:m}of g){const g=document.createElement("div");g.classList.add("SrContainerObjectTreeNode");const n=document.createElement("div");n.classList.add("SrContainerObjectTreeChildren");const o=document.createElement(h?"a":"div");o.classList.add("SrContainerObjectTreeLink"),h&&(o.href=h,i&&(o.target="_blank"));const p=document.createElement("img");p.classList.add("SrContainerObjectTreeIcon"),p.src=d,o.appendChild(p);const q=document.createElement("div");if(q.classList.add("SrContainerObjectTreeTitle"),q.innerText=m,o.appendChild(q),e){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeArrow");const b=this.clickNode.bind(this,{arrow_el:a,children_el:n,current_deep:f,ref_id:j});k&&(a.addEventListener("click",b),!h&&o.addEventListener("click",b),g.appendChild(a)),l&&b()}if(g.appendChild(o),c){const a=document.createElement("div");a.classList.add("SrContainerObjectTreeDescription"),a.innerText=c,g.appendChild(a)}if(e&&0<a.length){const b=document.createElement("div");b.classList.add("SrContainerObjectTreeCountSubChildrenTypes"),b.innerText=a.map(({count:a,type_title:b})=>`${a} ${b}`).join(", "),g.appendChild(b)}e&&g.appendChild(n),b.appendChild(g)}else{const a=document.createElement("div");a.classList.add("SrContainerObjectTreeEmpty"),a.innerText=this.tree_empty_text,b.appendChild(a)}}init(){this.initTree(),this.initEditUserSettings()}async initTree(){this.clearElement({el:this.tree_el}),await this.fetchTree({parent_deep:0,parent_el:this.tree_el,parent_ref_id:this.tree_container_ref_id})}async initEditUserSettings(){this.edit_user_settings_icon_el.addEventListener("click",this.handleOpenCloseUserSettingsIcon.bind(this,{}));for(const a of[this.edit_user_settings_form_el,this.edit_user_settings_icon_el])a.addEventListener("click",a=>{a.stopPropagation()});await this.fetchEditUserSettings({parent_el:this.edit_user_settings_form_el})}initEditUserSettingsForm({html:a,parent_el:b}){b.insertAdjacentHTML("beforeend",a);const c=b.querySelector("form");c.addEventListener("change",this.updateEditUserSettings.bind(this,{form:c,parent_el:b}))}insertError({err:a,error_text:b,parent_el:c}){console.error(a);const d=document.createElement("div");return d.classList.add("SrContainerObjectTreeError"),d.innerText=b,c.appendChild(d),d}insertLoading({parent_el:a}){const b=document.createElement("div");return b.classList.add("SrContainerObjectTreeLoading"),a.appendChild(b),b}removeLoading({loading_el:a,parent_el:b}){b.removeChild(a)}async updateEditUserSettings({form:a,parent_el:b}){const c=new FormData(a);for(const c of a.querySelectorAll("button,input,select,textarea"))c.disabled=!0;const d=this.insertLoading({parent_el:b});let e;try{e=await(await fetch(a.action,{body:c,headers:{accept:"application/json"},method:a.method})).json()}catch(a){return void this.insertError({err:a,error_text:this.edit_user_settings_error_text,parent_el:b})}finally{this.removeLoading({loading_el:d,parent_el:b})}this.clearElement({el:b});const{html:f,ok:g}=e;this.initEditUserSettingsForm({html:f,parent_el:b}),g&&(await this.initTree())}}for(const b of document.querySelectorAll(".SrContainerObjectTree")){const c=JSON.parse(atob(b.dataset.config)),d=b.querySelector(".SrContainerObjectTreeEditUserSettings");c.edit_user_settings_form_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsForm"),c.edit_user_settings_icon_el=d.querySelector(".SrContainerObjectTreeEditUserSettingsIcon"),c.tree_el=b.querySelector(".SrContainerObjectTreeTree");const e=new a(c);e.init()}});
